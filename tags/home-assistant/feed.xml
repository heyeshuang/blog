<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Home Assistant on 林中阴影</title><link>https://blog.heysh.xyz/tags/home-assistant/</link><description>Recent content in Home Assistant on 林中阴影</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>&amp;copy;贺叶霜，&lt;a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA&lt;/a></copyright><lastBuildDate>Thu, 10 Aug 2023 20:35:54 +0800</lastBuildDate><atom:link href="https://blog.heysh.xyz/tags/home-assistant/feed.xml" rel="self" type="application/rss+xml"/><item><title>一些矿渣的耗电量</title><link>https://blog.heysh.xyz/2023/08/10/energy-cost/</link><pubDate>Thu, 10 Aug 2023 20:35:54 +0800</pubDate><guid>https://blog.heysh.xyz/2023/08/10/energy-cost/</guid><description>&lt;p>最近在小黄鱼上淘到一个支持电量统计的插排（&lt;a href="https://post.smzdm.com/p/a304w8vk/p3/?sort_tab=hot/#comments">这个&lt;/a>），卖家还贴心地刷好了ESPHome固件。&lt;/p>
&lt;figure>&lt;img src="https://blog.heysh.xyz/2023/08/10/energy-cost/figure.png">&lt;figcaption>
&lt;h4>数据就不标了，有兴趣的可以自行使用Engauge Digitizer&lt;/h4>
&lt;/figcaption>
&lt;/figure>
&lt;p>于是我用Excel算好了：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>功率/W&lt;/th>
&lt;th>年功耗/kWh&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>插座&lt;/td>
&lt;td>3.8&lt;/td>
&lt;td>33.288&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>我家云&lt;/td>
&lt;td>5.4&lt;/td>
&lt;td>47.304&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>锐角云&lt;/td>
&lt;td>4.7&lt;/td>
&lt;td>41.172&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>蜗牛星际&lt;/td>
&lt;td>40.8&lt;/td>
&lt;td>357.408&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>首先是这个插排，本身待机就有3.8W，离谱。&lt;/li>
&lt;li>&lt;code>锐角云&lt;/code>开启之后总电量为8.9W，本身耗电4.7W。锐角云的配置是N3450、8GB内存，上面插了一块256G的SATA SSD，运行PVE、Home Assistant和另外2个虚拟机，直插12V电源适配器把待机功耗控制在极低的水平。&lt;/li>
&lt;li>9.6W的部分是&lt;code>我家云&lt;/code>的贡献。孱弱的RK3328核心，捉襟见肘的2G内存，即使再加上一块500G的2.5寸机械硬盘，耗电量也仅为5.4W，作为小型文件服务器可以直接忘掉电费问题。&lt;/li>
&lt;li>而&lt;code>蜗牛星际&lt;/code>就可以算上电老虎了。1块老旧SSD，两块老旧2.5寸和一块8T海淘盘带来了&lt;strong>高达&lt;/strong>40.8W的耗电，如果24小时开机的话每年会带来&lt;strong>高达&lt;/strong>一百多块的账单。&lt;/li>
&lt;/ul>
&lt;figure>&lt;img src="https://blog.heysh.xyz/2023/08/10/energy-cost/%E4%BB%8A%E5%B9%B4.png" width="50%">&lt;figcaption>
&lt;h4>顺便一提，我家今年的耗电量长这样。这才仅仅是8月而已……&lt;/h4>
&lt;/figcaption>
&lt;/figure>
&lt;p>OK，当我今天没有更新过。&lt;/p></description></item><item><title>“智能”家居笔记，其之二</title><link>https://blog.heysh.xyz/2023/03/08/silly-home-notes-detailed/</link><pubDate>Wed, 08 Mar 2023 21:32:06 +0800</pubDate><guid>https://blog.heysh.xyz/2023/03/08/silly-home-notes-detailed/</guid><description>&lt;p>书接&lt;a href="https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/">上文&lt;/a>。说起来，智能家居的可复制性在软件领域里是比较差的，在完成基础的环境搭建之后，功能需求要根据自己的实际情况来决定，以下的所有内容仅供抛砖引玉之用。&lt;/p>
&lt;h2 id="前端显示">前端显示&lt;/h2>
&lt;p>隆重推荐&lt;a href="https://github.com/dwainscheeren/dwains-lovelace-dashboard">Dwains dashboard&lt;/a>，这是在HA生态系统下仅有的不怎么需要折腾的部分。只需要把每个设备的&lt;em>区域&lt;/em>选好，就可以得到一组还不错的面板：&lt;/p>
&lt;p>&lt;img src="dwains.png" alt="Dwains dashboard">&lt;/p>
&lt;p>而&lt;a href="https://experiencelovelace.github.io/ha-floorplan/">Floorplan&lt;/a>是另一个极端，这个组件需要很久——非常久——才能够完成，而完成之后也只有无尽的空虚。为了缓解这空虚我也姑且把截图放在这里。&lt;/p>
&lt;p>&lt;img src="floorplan.png" alt="Floorplan">&lt;/p>
&lt;h2 id="手机消息提醒">手机消息提醒&lt;/h2>
&lt;p>作为没有统一推送服务的安卓用户，加入新的后台程序无异于火上浇油，所以最经济的方法是投靠大流氓微信。之前互联网上常见的方法是&lt;a href="https://www.jianshu.com/p/182ea14af3f2">企业微信发送应用消息&lt;/a>，不过到了2023年，这种方式需要绑定固定IP和域名，所以我换成了&lt;a href="https://www.pushplus.plus/doc/extend/webhook.html#%E5%BC%95%E8%A8%80">企业微信机器人&lt;/a>。这种方法需要有一个微信群（两人以上），对单身贵族不是十分友好。&lt;/p>
&lt;p>在获得Webhook地址之后，在HA配置文件中添加以下行：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#09f;font-style:italic"># configuration.yaml&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#309;font-weight:bold">rest_command&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">wechat_message&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">url&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#34;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=略&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">method&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>post&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">content_type&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#39;application/json&amp;#39;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">payload&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#39;{&amp;#34;msgtype&amp;#34;:&amp;#34;text&amp;#34;,&amp;#34;text&amp;#34;:{&amp;#34;content&amp;#34;:&amp;#34;{{ message }}&amp;#34;}}&amp;#39;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>就可以在自动化中&lt;code>Call a service&lt;/code>，调用&lt;code>wechat_message&lt;/code>了。&lt;/p>
&lt;p>&lt;img src="rest_command.png" alt="">&lt;/p>
&lt;p>另外，可以试试&lt;a href="https://blog.star7th.com/2022/03/2421.html">showdoc推送服务&lt;/a>。我没用过，不对这个负责。&lt;/p>
&lt;p>或者直接想办法给微信绑定的QQ邮箱发信，反正他们信用卡诈骗邮件都是这么干的。&lt;/p>
&lt;p>&lt;img src="QQmail.png" alt="推送的非常及时">&lt;/p>
&lt;p>或者直接用Home Assistant自带的&lt;a href="https://www.home-assistant.io/integrations/html5">HTML5 Push Notifications&lt;/a>；或者TG机器人；或者自建&lt;a href="https://ntfy.sh/">ntfy.sh&lt;/a>——反正都很复杂。&lt;/p>
&lt;h2 id="开关其他计算机">开关其他计算机&lt;/h2>
&lt;p>当前，因为不想和国家电网签约，我在平时保持台式机和NAS处于关闭状态，只在需要时通过HA所在的矿渣来&lt;a href="https://www.home-assistant.io/integrations/wake_on_lan/">Wake on LAN&lt;/a>。&lt;/p>
&lt;p>开机问题解决了，关闭需要另外的解决方式。对于Windows系统，可以使用&lt;a href="https://gitlab.com/iotlink/iotlink/-/wikis/Addons/Commands">IOT Link&lt;/a>；而对于更常用的Linux系统，可以使用SSH来运行shutdown。仍然是HA配置文件：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#09f;font-style:italic">#configuration.yaml&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#309;font-weight:bold">switch&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#309;font-weight:bold">platform&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>wake_on_lan&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Trashbin&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">mac&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">host&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#f60">192.168.8.88&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#09f;font-style:italic">#用ping来检测是否已开机&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">turn_off&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">service&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>shell_command.turn_off_trashbin&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#309;font-weight:bold">shell_command&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">turn_off_trashbin&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#34;ssh -i /config/ssh_keys/id_rsa_homeassistant -o &amp;#39;StrictHostKeyChecking=no&amp;#39; user@192.168.8.88 &amp;#39;sudo /usr/bin/systemctl poweroff&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>别忘了把私钥放在&lt;code>/config/ssh_keys/id_rsa_homeassistant&lt;/code>，并上传公钥。在&lt;code>authorized_keys&lt;/code>中动些手脚，可以&lt;a href="https://www.virtono.com/community/tutorial-how-to/restrict-executable-ssh-commands-with-authorized-keys/">限制SSH允许执行的命令&lt;/a>。另外，需要设置sudo在运行poweroff时不需要密码。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#09f;font-style:italic">## sudo visudo&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>%sudo &lt;span style="color:#033">ALL&lt;/span>&lt;span style="color:#555">=(&lt;/span>ALL&lt;span style="color:#555">)&lt;/span> NOPASSWD: /usr/bin/systemctl poweroff
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="远程访问">远程访问&lt;/h2>
&lt;p>&lt;a href="https://blog.heysh.xyz/2023/02/07/beyond-nat-2023/">之前这篇文章&lt;/a>就是为了这个。&lt;/p>
&lt;h2 id="在家检测">在家检测&lt;/h2>
&lt;p>又名device tracker，与路由器有关，我用了&lt;a href="https://www.home-assistant.io/integrations/luci/">OpenWrt (luci)&lt;/a>集成。独居的话，&lt;a href="https://github.com/AlexxIT/XiaomiGateway3/wiki/Handle-BLE-Locks">BLE门锁&lt;/a>也能完成类似的工作。控制欲更强的朋友可以尝试&lt;a href="https://github.com/ESPresense/ESPresense">ESPresense&lt;/a>，应该是能到房间级别。&lt;/p>
&lt;h2 id="零冷水">零冷水&lt;/h2>
&lt;p>如果你像我家一样，燃气热水器/壁挂炉离浴室太远，需要一套零冷水系统，那么首先需要把回水管留好。然后……最好能搞点&lt;a href="https://www.xiaomiyoupin.com/detail?gid=152447">成品系统&lt;/a>，不要像我一样用&lt;a href="https://item.taobao.com/item.htm?spm=a1z09.2.0.0.ef352e8dz7aUZB">屏蔽泵&lt;/a>和智能开关解决，毕竟这玩意还是有一定难度的。
&lt;figure>&lt;img src="https://blog.heysh.xyz/2023/03/08/silly-home-notes-detailed/pump.jpg"
alt="设计水路和买接头全要靠自己了。">&lt;figcaption>
&lt;p>设计水路和买接头全要靠自己了。&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>弄完之后，把水泵插在智能插座上，在卫生间安装人体传感器，每当卫生间有人经过的时候就运行半小时。&lt;/p>
&lt;p>没有预留回水管的话可以参考&lt;a href="https://post.smzdm.com/p/a9g2nm9o/">这里&lt;/a>。&lt;/p>
&lt;h2 id="自适应照明">自适应照明&lt;/h2>
&lt;p>……&lt;a href="https://post.smzdm.com/p/a8x5xqpl/">感觉很高级&lt;/a>，没了。&lt;/p>
&lt;h2 id="监控摄像">监控摄像&lt;/h2>
&lt;p>为了照料人类幼崽，我买了3个摄像头，是广受好评的TP-link系列&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>，ONVIF协议除了端口是&lt;code>:2020&lt;/code>之外和标准一模一样，也自然支持HA的&lt;a href="https://www.home-assistant.io/integrations/onvif/">ONVIF&lt;/a>集成。&lt;/p>
&lt;p>因为正好有一台杂牌NAS，硬盘录像机的钱可以省掉了。NVR软件方面，我尝试了&lt;code>Shinobi.video&lt;/code>&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>和&lt;code>motioneye&lt;/code>&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>，最后选了iSpy公司的&lt;a href="https://www.ispyconnect.com/download.aspx">Agent DVR&lt;/a>，设置最简单，也具有最完善的HA集成，抱歉啦开源社区。&lt;/p>
&lt;h2 id="附当前用到的自动化">附：当前用到的自动化&lt;/h2>
&lt;ul>
&lt;li>按下开关 -&amp;gt; 关掉对应的灯
&lt;blockquote>
&lt;p>每个灯都要做一次，很无聊。但是设置完之后，每个灯都能缓缓熄灭，就……挺高级的。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>开关窗帘
&lt;ul>
&lt;li>在每天晚上8:00自动关闭所有窗帘&lt;/li>
&lt;li>我在家的情况下，当我的下一个闹钟响起时，打开主卧窗帘&lt;/li>
&lt;li>早上8:30打开所有窗帘&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>浴室门
&lt;ul>
&lt;li>浴室门关闭 -&amp;gt; 打开照明、打开循环泵&lt;/li>
&lt;li>浴室门开启 -&amp;gt; 关闭照明、关闭浴霸制热、等待十分钟 -&amp;gt; 关闭浴霸通风&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>防盗门
&lt;ul>
&lt;li>&lt;a href="https://github.com/AlexxIT/XiaomiGateway3/wiki/Handle-BLE-Locks">门从外部被打开&lt;/a> -&amp;gt; 打开门厅灯、打开循环水，如果在8:00-22:00间，小爱播报“欢迎回家”。
&lt;blockquote>
&lt;p>就……挺高级的……吧……&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>循环泵
&lt;ul>
&lt;li>每天午夜关闭循环泵&lt;/li>
&lt;li>开启30分钟后关闭循环泵&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>在电费余额不足时，向企业微信发送信息&lt;/li>
&lt;/ul>
&lt;p>暂时我还没搞懂&lt;code>NodeRED&lt;/code>是干什么用的，看起来&lt;a href="https://community.home-assistant.io/t/pyscript-new-integration-for-easy-and-powerful-python-scripting">pyscript&lt;/a>还更有趣一些。&lt;/p>
&lt;h3 id="heading">&lt;/h3>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>型号是TL-IPC44AW Pro，那个Pro让它多了5G wifi支持。&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>不太支持H.265格式的录制，实时播放老有问题，而且没搞懂HA集成怎么用。&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>这个我没仔细试，祝你成功！&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>“智能”家居笔记，其之一</title><link>https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/</link><pubDate>Fri, 10 Feb 2023 20:44:06 +0800</pubDate><guid>https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/</guid><description>&lt;blockquote>
&lt;p>而RK3328的算力与草履虫大约能打成平手。所以，本文中的“智能”指的都是 &lt;em>不用按电钮就能控制™&lt;/em> 级别，当然，如果能够有一点点自动就更好了。&lt;/p>
&lt;/blockquote>
&lt;h2 id="前期的准备">前期的准备&lt;/h2>
&lt;h3 id="考虑一下">考虑一下&lt;/h3>
&lt;p>其实当个mi boy也不错——全屋小米设备是智能家居方案里面最不坏的选择，做完就可以成为合格的家居up主了&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>。不过，如果不想被锁定在米系势力范围内，可以尝试一下Home Assistant，尝试成本也不高：几十块钱的魔百盒或者玩客云，或者直接虚拟机都可以。另外，最好能有一个简单的设备来控制，我觉得带红外遥控的小爱音箱 Pro就挺好的。&lt;/p>
&lt;h3 id="装修时">装修时&lt;/h3>
&lt;p>当然是老生常谈的那些：在开关里面留零线、不要做双控（贵）、多做网线口、窗帘盒旁边做插座之类的，剩下的事情只能等到装完以后再后悔了。&lt;/p>
&lt;p>就我来说，我比较后悔没有给拖地机器人留上下水的位置，没有把净水器的纯水管引到客厅，也没有留两个给摄像头和人体存在传感器的插座。&lt;/p>
&lt;h2 id="新手的采购清单">新手的采购清单&lt;/h2>
&lt;p>最好能够遵循 &lt;em>Graceful degradation&lt;/em> 原则：保证有东西坏掉的时候至少还是个mi boy，然后就可以把所有问题推到米家服务器身上了。另一方面，如果要在熟练后彻底摆脱米家的控制，需要寻找那些离线仍然可以通过HA控制的设备，也就是说，最好不要选择米家&lt;del>臭名昭著的&lt;/del>最新的BLE Mesh系列。那么，在2022年，我的选择是大量的Zigbee设备、少量的Wifi设备和更少的蓝牙设备。Nothing Matter.&lt;/p>
&lt;details>
&lt;summary>
&lt;h4 class="inline">
下面是米系智能设备的列表，截至2022年。盛惠5527元。
&lt;/h4>
&lt;/summary>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>设备&lt;/th>
&lt;th>数量&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>墙壁开关E1（零火双键）&lt;/td>
&lt;td>10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Aqara双色温LED灯泡T1&lt;/td>
&lt;td>6&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Aqara智能墙壁插座Zigbee&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Aqara水浸传感器&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Aqara人体传感器&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Aqara门窗传感器&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Aqara温湿度传感器&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>yeelight m3筒灯（BLE）&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>米家第三方壁灯（BLE）&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>米家客厅吸顶灯&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>米家卧室吸顶灯450&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>米家卧室吸顶灯350&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>杜亚M2米家款电机（Aqara的买不起）&lt;/td>
&lt;td>3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>门锁1s（BLE）&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>小米多模网关&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;/details>
&lt;p>Aqara在闲鱼买会显得不那么冤大头，杜亚牌电机也比杜亚代工的Aqara电机便宜很多。家电方面，美的和其副牌（小天鹅、华凌、colmo之类）一般自带网络功能，通过插件&lt;a href="https://github.com/georgezhao2010/midea_ac_lan">midea_ac_lan&lt;/a>和HA配合的很不错。&lt;/p>
&lt;figure>&lt;img src="https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/midea.png"
alt="美的营销号矩阵">&lt;figcaption>
&lt;p>美的营销号矩阵&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>对了，还需要一台能够24小时开机的设备，比如NAS啊、矿渣啊什么的。&lt;/p>
&lt;h2 id="安装和设置">安装和设置&lt;/h2>
&lt;p>安装HA的部分在此不再赘述。通过米家APP配置以上的所有设备，并使用&lt;a href="https://github.com/al-one/hass-xiaomi-miot">hass-xiaomi-miot&lt;/a>和&lt;a href="https://github.com/AlexxIT/XiaomiGateway3#supported-firmwares">XiaomiGateway3&lt;/a>导入HA。这里需要注意的是，&lt;code>hass-xiaomi-miot&lt;/code>集成只能对WiFi设备进行本地控制，对Zigbee和BLE设备&lt;a href="https://github.com/al-one/hass-xiaomi-miot/issues/100#issuecomment-855183156">需要通过米家服务器&lt;/a>。所以最好由&lt;code>gateway3&lt;/code>控制这些设备，在&lt;code>hass-xiaomi-miot&lt;/code>集成中禁用。&lt;/p>
&lt;p>考虑到安装非智能灯的可能性，我采用了&lt;code>智能开关+智能灯&lt;/code>的组合，这种组合更为保守，&lt;code>凌动开关+支持凌动的智能灯&lt;/code>效果大概会更好。在把所有智能灯配置完成后，在米家APP上把链接智能灯的开关&lt;code>转为无线开关&lt;/code>，然后在HA中设置自动化，感觉比米家自动化的反应更灵敏一些。不过，为了防止在HA断掉时挨骂，我也在米家APP上添加了备份：在同时按下开关左右键的时候关闭智能灯。&lt;/p>
&lt;figure>&lt;img src="https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/double-auto.jpg"
alt="HA和米家设置自动化">&lt;figcaption>
&lt;p>HA和米家设置自动化&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>这样，在关闭智能灯的时候不会断电，可以实现灯光缓灭、&lt;a href="https://github.com/basnijholt/adaptive-lighting">自适应照明&lt;/a>等高级功能。&lt;/p>
&lt;p>窗帘的部分就更简单了，只要定时开关就行。通过HA的手机APP，可以将&lt;a href="https://companion.home-assistant.io/docs/core/sensors/#next-alarm-sensor">下一个闹钟时间&lt;/a>导入自动化，实现闹铃响起时打开窗帘。&lt;/p>
&lt;h2 id="附加题部分">附加题部分&lt;/h2>
&lt;p>在基本框架（aka灯和窗帘）搭好之后，就可以放飞自我搞一些新花样，这里举两个例子。&lt;/p>
&lt;h3 id="智能面板">智能面板&lt;/h3>
&lt;p>&lt;a href="https://detail.1688.com/offer/662976153559.html?spm=a26352.13672862.offerlist.49.3a512910uzdgfQ">Sonoff NSPanel&lt;/a>应该是最便宜的智能面板了，而且可以刷第三方固件&lt;a href="https://github.com/joBr99/nspanel-lovelace-ui">lovelace-ui&lt;/a>或&lt;a href="https://github.com/Blackymas/NSPanel_HA_Blueprint">NSPanel_HA_Blueprint&lt;/a>，可玩性非常高。&lt;/p>
&lt;p>&lt;img src="nspanel-rl.png" alt="NSPanel Lovelace UI">&lt;/p>
&lt;p>如果需要更大的屏幕，甚至可以在仓库里找一些淘汰的设备，比如说还能亮的山寨平板、二手安卓手机、闲鱼低价带屏开发板之类。通过&lt;a href="https://wallpanel.xyz/">WallPanel&lt;/a>和&lt;a href="https://github.com/NemesisRE/kiosk-mode">HA的kiosk-mode插件&lt;/a>，可以让这些设备直接成为HA的前端显示&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>。&lt;/p>
&lt;figure>&lt;img src="https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/panel.jpg"
alt="一个二手安卓触摸屏">&lt;figcaption>
&lt;p>一个二手安卓触摸屏&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;p>作为一个直男，还有一件事情要嘱咐：不要搞得太丑了，正常人不会喜欢满墙飞线的，至少拿个相框遮一下。这部分我也不会，所以我从网上找了一张图。&lt;/p>
&lt;p>&lt;img src="frame.webp" alt="reddit：surface_pro_3_wall_tablet_install，这张图也挺丑的">&lt;/p>
&lt;h3 id="esphome">ESPHome&lt;/h3>
&lt;p>传感器是从遥控家居走向智能的关键一步，在需要更多种类的传感器时，&lt;a href="https://esphome.io/">ESPHome&lt;/a>能够派上用场。只需要一块ESP32，加上AHT20就是温湿度计，&lt;del>加上SGP30是TVOC检测仪&lt;/del>&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>，加上PZEM-004T就是智能电流表，加上LD2410就是人体感应雷达，而且都可以与HA控制的所有设备联动。唯一的问题是，ESP32系列一般是通过Wifi联网，可能会对路由器造成一点点压力，如果是一万块钱的高级路由器K3就无所谓了。&lt;/p>
&lt;p>另外，如果完全不想和小米打交道，易微联、涂鸦或小燕科技的设备也可以试试。没准过几&lt;del>天&lt;/del>年Matter设备也会上市？&lt;/p>
&lt;hr>
&lt;p>那么关于智能家居的第一部分在此告一段落，之后会记录一些&lt;a href="https://blog.heysh.xyz/2023/03/08/silly-home-notes-detailed/">更为个性化的部分&lt;/a>，而今天又是一个思念192.168.1.1的日子。虽然心已随着VPN回到家乡，但身体仍在公网上漂泊。&lt;/p>
&lt;h2 id="参考">参考&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://bbs.hassbian.com/thread-16261-1-1.html">HA智能硬件采购避坑指要&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://post.m.smzdm.com/p/a85gplo7/?from=other&amp;amp;invite_code=zdm8xwesxhinv&amp;amp;send_by=6416413937&amp;amp;utm_source=pocket_mylist&amp;amp;zdm_ss=Android_6416413937_">论如何打造一个科技爱好者/直男审美的家——（五）智能家居&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/87595668">智能家居防悔全指南(小米/绿米)&lt;/a>&lt;/li>
&lt;/ul>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>那么你可以直接跳过这篇文章，不会有什么损失。&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>HA前端对浏览器版本有一定要求。如果设备过于古老的话，可能需要手动更新Webview，见&lt;a href="https://blakadder.com/android-panel-webview/">此处&lt;/a>。&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>这个不要用，长期开机读数会暴涨。&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item></channel></rss>