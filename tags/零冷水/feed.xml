<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>零冷水 on 林中阴影</title><link>https://blog.heysh.xyz/tags/%E9%9B%B6%E5%86%B7%E6%B0%B4/</link><description>Recent content in 零冷水 on 林中阴影</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><copyright>&amp;copy;贺叶霜，&lt;a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh">CC BY-SA&lt;/a></copyright><lastBuildDate>Wed, 08 Mar 2023 21:32:06 +0800</lastBuildDate><atom:link href="https://blog.heysh.xyz/tags/%E9%9B%B6%E5%86%B7%E6%B0%B4/feed.xml" rel="self" type="application/rss+xml"/><item><title>“智能”家居笔记，其之二</title><link>https://blog.heysh.xyz/2023/03/08/silly-home-notes-detailed/</link><pubDate>Wed, 08 Mar 2023 21:32:06 +0800</pubDate><guid>https://blog.heysh.xyz/2023/03/08/silly-home-notes-detailed/</guid><description>&lt;p>书接&lt;a href="https://blog.heysh.xyz/2023/02/10/silly-home-notes-1/">上文&lt;/a>。说起来，智能家居的可复制性在软件领域里是比较差的，在完成基础的环境搭建之后，功能需求要根据自己的实际情况来决定，以下的所有内容仅供抛砖引玉之用。&lt;/p>
&lt;h2 id="前端显示">前端显示&lt;/h2>
&lt;p>隆重推荐&lt;a href="https://github.com/dwainscheeren/dwains-lovelace-dashboard">Dwains dashboard&lt;/a>，这是在HA生态系统下仅有的不怎么需要折腾的部分。只需要把每个设备的&lt;em>区域&lt;/em>选好，就可以得到一组还不错的面板：&lt;/p>
&lt;p>&lt;img src="dwains.png" alt="Dwains dashboard">&lt;/p>
&lt;p>而&lt;a href="https://experiencelovelace.github.io/ha-floorplan/">Floorplan&lt;/a>是另一个极端，这个组件需要很久——非常久——才能够完成，而完成之后也只有无尽的空虚。为了缓解这空虚我也姑且把截图放在这里。&lt;/p>
&lt;p>&lt;img src="floorplan.png" alt="Floorplan">&lt;/p>
&lt;h2 id="手机消息提醒">手机消息提醒&lt;/h2>
&lt;p>作为没有统一推送服务的安卓用户，加入新的后台程序无异于火上浇油，所以最经济的方法是投靠大流氓微信。之前互联网上常见的方法是&lt;a href="https://www.jianshu.com/p/182ea14af3f2">企业微信发送应用消息&lt;/a>，不过到了2023年，这种方式需要绑定固定IP和域名，所以我换成了&lt;a href="https://www.pushplus.plus/doc/extend/webhook.html#%E5%BC%95%E8%A8%80">企业微信机器人&lt;/a>。这种方法需要有一个微信群（两人以上），对单身贵族不是十分友好。&lt;/p>
&lt;p>在获得Webhook地址之后，在HA配置文件中添加以下行：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#09f;font-style:italic"># configuration.yaml&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#309;font-weight:bold">rest_command&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">wechat_message&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">url&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#34;https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=略&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">method&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>post&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">content_type&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#39;application/json&amp;#39;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">payload&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#39;{&amp;#34;msgtype&amp;#34;:&amp;#34;text&amp;#34;,&amp;#34;text&amp;#34;:{&amp;#34;content&amp;#34;:&amp;#34;{{ message }}&amp;#34;}}&amp;#39;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>就可以在自动化中&lt;code>Call a service&lt;/code>，调用&lt;code>wechat_message&lt;/code>了。&lt;/p>
&lt;p>&lt;img src="rest_command.png" alt="">&lt;/p>
&lt;p>另外，可以试试&lt;a href="https://blog.star7th.com/2022/03/2421.html">showdoc推送服务&lt;/a>。我没用过，不对这个负责。&lt;/p>
&lt;p>或者直接想办法给微信绑定的QQ邮箱发信，反正他们信用卡诈骗邮件都是这么干的。&lt;/p>
&lt;p>&lt;img src="QQmail.png" alt="推送的非常及时">&lt;/p>
&lt;p>或者直接用Home Assistant自带的&lt;a href="https://www.home-assistant.io/integrations/html5">HTML5 Push Notifications&lt;/a>；或者TG机器人；或者自建&lt;a href="https://ntfy.sh/">ntfy.sh&lt;/a>——反正都很复杂。&lt;/p>
&lt;h2 id="开关其他计算机">开关其他计算机&lt;/h2>
&lt;p>当前，因为不想和国家电网签约，我在平时保持台式机和NAS处于关闭状态，只在需要时通过HA所在的矿渣来&lt;a href="https://www.home-assistant.io/integrations/wake_on_lan/">Wake on LAN&lt;/a>。&lt;/p>
&lt;p>开机问题解决了，关闭需要另外的解决方式。对于Windows系统，可以使用&lt;a href="https://gitlab.com/iotlink/iotlink/-/wikis/Addons/Commands">IOT Link&lt;/a>；而对于更常用的Linux系统，可以使用SSH来运行shutdown。仍然是HA配置文件：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#09f;font-style:italic">#configuration.yaml&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#309;font-weight:bold">switch&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#309;font-weight:bold">platform&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>wake_on_lan&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Trashbin&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">mac&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>:&lt;span style="color:#f60">00&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">host&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#f60">192.168.8.88&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#09f;font-style:italic">#用ping来检测是否已开机&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">turn_off&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">service&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>shell_command.turn_off_trashbin&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#309;font-weight:bold">shell_command&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#309;font-weight:bold">turn_off_trashbin&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#c30">&amp;#34;ssh -i /config/ssh_keys/id_rsa_homeassistant -o &amp;#39;StrictHostKeyChecking=no&amp;#39; user@192.168.8.88 &amp;#39;sudo /usr/bin/systemctl poweroff&amp;#39;&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>别忘了把私钥放在&lt;code>/config/ssh_keys/id_rsa_homeassistant&lt;/code>，并上传公钥。在&lt;code>authorized_keys&lt;/code>中动些手脚，可以&lt;a href="https://www.virtono.com/community/tutorial-how-to/restrict-executable-ssh-commands-with-authorized-keys/">限制SSH允许执行的命令&lt;/a>。另外，需要设置sudo在运行poweroff时不需要密码。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#09f;font-style:italic">## sudo visudo&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>%sudo &lt;span style="color:#033">ALL&lt;/span>&lt;span style="color:#555">=(&lt;/span>ALL&lt;span style="color:#555">)&lt;/span> NOPASSWD: /usr/bin/systemctl poweroff
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="远程访问">远程访问&lt;/h2>
&lt;p>&lt;a href="https://blog.heysh.xyz/2023/02/07/beyond-nat-2023/">之前这篇文章&lt;/a>就是为了这个。&lt;/p>
&lt;h2 id="在家检测">在家检测&lt;/h2>
&lt;p>又名device tracker，与路由器有关，我用了&lt;a href="https://www.home-assistant.io/integrations/luci/">OpenWrt (luci)&lt;/a>集成。独居的话，&lt;a href="https://github.com/AlexxIT/XiaomiGateway3/wiki/Handle-BLE-Locks">BLE门锁&lt;/a>也能完成类似的工作。控制欲更强的朋友可以尝试&lt;a href="https://github.com/ESPresense/ESPresense">ESPresense&lt;/a>，应该是能到房间级别。&lt;/p>
&lt;h2 id="零冷水">零冷水&lt;/h2>
&lt;p>如果你像我家一样，燃气热水器/壁挂炉离浴室太远，需要一套零冷水系统，那么首先需要把回水管留好。然后……最好能搞点&lt;a href="https://www.xiaomiyoupin.com/detail?gid=152447">成品系统&lt;/a>，不要像我一样用&lt;a href="https://item.taobao.com/item.htm?spm=a1z09.2.0.0.ef352e8dz7aUZB">屏蔽泵&lt;/a>和智能开关解决，毕竟这玩意还是有一定难度的。
&lt;figure>&lt;img src="pump.jpg"
alt="设计水路和买接头全要靠自己了。"/>&lt;figcaption>
&lt;p>设计水路和买接头全要靠自己了。&lt;/p>
&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>弄完之后，把水泵插在智能插座上，在卫生间安装人体传感器，每当卫生间有人经过的时候就运行半小时。&lt;/p>
&lt;p>没有预留回水管的话可以参考&lt;a href="https://post.smzdm.com/p/a9g2nm9o/">这里&lt;/a>。&lt;/p>
&lt;h2 id="自适应照明">自适应照明&lt;/h2>
&lt;p>……&lt;a href="https://post.smzdm.com/p/a8x5xqpl/">感觉很高级&lt;/a>，没了。&lt;/p>
&lt;h2 id="监控摄像">监控摄像&lt;/h2>
&lt;p>为了照料人类幼崽，我买了3个摄像头，是广受好评的TP-link系列&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>，ONVIF协议除了端口是&lt;code>:2020&lt;/code>之外和标准一模一样，也自然支持HA的&lt;a href="https://www.home-assistant.io/integrations/onvif/">ONVIF&lt;/a>集成。&lt;/p>
&lt;p>因为正好有一台杂牌NAS，硬盘录像机的钱可以省掉了。NVR软件方面，我尝试了&lt;code>Shinobi.video&lt;/code>&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>和&lt;code>motioneye&lt;/code>&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>，最后选了iSpy公司的&lt;a href="https://www.ispyconnect.com/download.aspx">Agent DVR&lt;/a>，设置最简单，也具有最完善的HA集成，抱歉啦开源社区。&lt;/p>
&lt;h2 id="附当前用到的自动化">附：当前用到的自动化&lt;/h2>
&lt;ul>
&lt;li>按下开关 -&amp;gt; 关掉对应的灯
&lt;blockquote>
&lt;p>每个灯都要做一次，很无聊。但是设置完之后，每个灯都能缓缓熄灭，就……挺高级的。&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>开关窗帘
&lt;ul>
&lt;li>在每天晚上8:00自动关闭所有窗帘&lt;/li>
&lt;li>我在家的情况下，当我的下一个闹钟响起时，打开主卧窗帘&lt;/li>
&lt;li>早上8:30打开所有窗帘&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>浴室门
&lt;ul>
&lt;li>浴室门关闭 -&amp;gt; 打开照明、打开循环泵&lt;/li>
&lt;li>浴室门开启 -&amp;gt; 关闭照明、关闭浴霸制热、等待十分钟 -&amp;gt; 关闭浴霸通风&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>防盗门
&lt;ul>
&lt;li>&lt;a href="https://github.com/AlexxIT/XiaomiGateway3/wiki/Handle-BLE-Locks">门从外部被打开&lt;/a> -&amp;gt; 打开门厅灯、打开循环水，如果在8:00-22:00间，小爱播报“欢迎回家”。
&lt;blockquote>
&lt;p>就……挺高级的……吧……&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>循环泵
&lt;ul>
&lt;li>每天午夜关闭循环泵&lt;/li>
&lt;li>开启30分钟后关闭循环泵&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>在电费余额不足时，向企业微信发送信息&lt;/li>
&lt;/ul>
&lt;p>暂时我还没搞懂&lt;code>NodeRED&lt;/code>是干什么用的，看起来&lt;a href="https://community.home-assistant.io/t/pyscript-new-integration-for-easy-and-powerful-python-scripting">pyscript&lt;/a>还更有趣一些。&lt;/p>
&lt;h3 id="heading">&lt;/h3>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>型号是TL-IPC44AW Pro，那个Pro让它多了5G wifi支持。&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>不太支持H.265格式的录制，实时播放老有问题，而且没搞懂HA集成怎么用。&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>这个我没仔细试，祝你成功！&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item></channel></rss>