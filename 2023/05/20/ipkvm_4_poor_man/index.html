<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>林中阴影 | 穷人的IP-KVM远程访问</title>
<meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.143.1"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/app.css rel=stylesheet><link rel="shortcut icon" href=https://blog.heysh.xyz/img/favicon.png type=image/png><script async src="https://www.googletagmanager.com/gtag/js?id=G-CWBXLVG90W"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CWBXLVG90W")}</script><link rel=stylesheet href=https://blog.heysh.xyz/lib/katex.min.css crossorigin=anonymous><script defer src=https://blog.heysh.xyz/lib/katex.min.js crossorigin=anonymous></script><script defer src=https://blog.heysh.xyz/lib/contrib/auto-render.min.js crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("https://blog.heysh.xyz/lib/pangu.min.js",function(){pangu.spacingPage()})</script><style type=text/css media="screen, print">@font-face{font-family:fancytitlefont;font-style:normal;font-display:swap;src:url(https://blog.heysh.xyz/fonts/%E6%9D%A8%E4%BB%BB%E4%B8%9C%E7%AB%B9%E7%9F%B3%E4%BD%93-Light.woff2)format('woff2'),url(https://blog.heysh.xyz/fonts/%E6%9D%A8%E4%BB%BB%E4%B8%9C%E7%AB%B9%E7%9F%B3%E4%BD%93-Light.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:300;font-display:swap;src:local('Noto Serif CJK SC Light'),local('NotoSerifCJK-Light'),url(https://blog.heysh.xyz/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff2)format('woff2'),url(https://blog.heysh.xyz/fonts/noto-serif-sc-v7-latin_chinese-simplified-300.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:400;font-display:swap;src:local('Noto Serif CJK SC'),local('NotoSerifCJK-Regular'),url(https://blog.heysh.xyz/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff2)format('woff2'),url(https://blog.heysh.xyz/fonts/noto-serif-sc-v7-latin_chinese-simplified-regular.woff)format('woff')}@font-face{font-family:noto serif cjk sc;font-style:normal;font-weight:500;font-display:swap;src:local('Noto Serif CJK SC Medium'),local('NotoSerifCJK-Medium'),url(https://blog.heysh.xyz/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff2)format('woff2'),url(https://blog.heysh.xyz/fonts/noto-serif-sc-v7-latin_chinese-simplified-500.woff)format('woff')}</style></head><body class="bg-gray-100 text-gray-700 font-sans"><div class="p-6 sm:p-10 md:p-16 flex flex-wrap"><header class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-1 md:order-1 max-w-2xl"><div class="z-50 bg-gray-100 bg-opacity-75 bg-opacity-custom lg:min-w-0.7 max-w-xl md:float-right md:text-right leading-loose tracking-tight md:sticky md:top-0 pt-2"><div><h2><a href=https://blog.heysh.xyz/ title=林中阴影 class="heading font-cursive icon">林中阴影</a></h2></div><h1 class=pt-2>穷人的IP-KVM远程访问</h1><h3 class="text-java-700 font-normal leading-relaxed pt-2">使用吃灰的N1盒子，没有Arduino</h3><div class="flex flex-wrap justify-end pt-2"><div class="md:flex-grow-0 font-light"><a class="post-taxonomy-category text-medium-red-violet-600 hover:text-medium-red-violet-400" href=/categories/%E6%8A%98%E8%85%BE>折腾</a>
&nbsp;&nbsp;
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/pikvm>PiKVM</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/ip-kvm>IP-KVM</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6>远程控制</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/%E5%86%85%E7%BD%91>内网</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/ipmi>IPMI</a>&nbsp;/
<a class="post-taxonomy-tag text-eucalyptus-500" href=/tags/n1>N1</a></div><time class="text-eucalyptus-500 md:text-right md:flex-grow font-light pl-4" datetime=2023-05-20T16:06:47+08:00>2023-5-20 16:06</time></div><hr></div></header><main role=main class="w-full md:w-3/5 xl:w-1/2 max-w-3xl order-2 md:order-2 min-h-70vh pt-2 pb-4"><article><section class="mx-auto content"><div class=c-rich-text><blockquote><p>说起DIY的IP-KVM，当然是<a href=https://github.com/pikvm/pikvm>PiKVM</a>以及一系列衍生项目，可是对于<del>那些把钱投入庞氏骗局的</del>穷人来说，RPI4已经远不能称为<em>inexpensive</em>。近几天，我从垃圾堆里翻出了<strong>同样</strong>昂贵的Phicomm N1和一张30块的视频采集卡，发现正好也能用。</p></blockquote><figure><img src=/2023/05/20/ipkvm_4_poor_man/pikvm.png alt=有较强的自我管理意识.png><figcaption><p>有较强的自我管理意识.png</p></figcaption></figure><p>把远程控制取名叫作IP-KVM，这对于SEO来说过于不友好了。每当搜索Google的时候，总会看到有人试图在N1上跑虚拟化（aka KVM），可能是对2G内存有些什么不切实际的幻想。最后，在GitHub上找到了在N1上安装PiKVM的脚本：<a href=https://github.com/toss-a/pikvm-armbian>toss-a/pikvm-armbian</a>。不过这里的<a href=https://github.com/toss-a/pikvm-armbian/blob/master/README-zh-CN.MD>说明</a>也稍微有些简略，我会努力稍微详细一点点，尽量。</p><p>那么，需要准备下面这些东西：</p><ol><li>N1一台；<blockquote><p>我的N1是从垃圾堆里捡回来的，如果是新购的话，应该会有一些更新、<a href=https://github.com/toss-a/pikvm-armbian/blob/master/README-zh-CN.MD#1%E9%80%89%E6%8B%A9%E5%8E%9F%E7%94%9F%E5%B8%A6%E6%9C%89otg%E7%9A%84%E5%BC%80%E5%8F%91%E7%89%88-%E4%BE%8B%E5%A6%82>更好的选择</a>。注意，这些选择需要能够OTG。</p></blockquote></li><li>USB公对公数据线一条；<blockquote><p>因为N1的USB口有OTG功能，直接连接被控电脑就可以模拟鼠标和键盘。</p></blockquote></li><li>视频采集卡一张，配HDMI线一条；<blockquote><p>因为N1没有USB3.0接口，MS2109芯片就足够了，可以跑1080p@30Hz。
<img src=ms2109.webp alt=大概长这样：></p></blockquote></li><li>U盘一块；</li><li>Linux知识一些；</li><li>可能会需要：<ol><li>USB键盘一个；</li><li>USB延长线一条；</li><li>理想的上网环境。<blockquote><p>根据相关法律法规和政策（下略）</p></blockquote></li></ol></li></ol><p>不需要准备Arduino、BadUSB、USB Rubber Ducky，或者其他的单片机，虽然我的垃圾堆里也有不少。</p><h2 id=安装系统armbianubuntu口味的>安装系统：Armbian（Ubuntu口味的）</h2><p>这部分已经有很多人写过了，大概步骤是降级—BalenaEcther镜像写入U盘—Armbian写入EMMC。可以参考<a href=https://github.com/ophub/amlogic-s9xxx-armbian/blob/main/README.cn.md#%E5%AE%89%E8%A3%85-armbian-%E5%88%B0-emmc>GitHub说明</a>、<a href=https://ethanblog.com/tips/play-with-n1-box.html>其他人的博客</a>或者<a href=https://www.bilibili.com/video/BV1QJ411k7AH/>B站</a>。要注意，在盒子的原始系统尚未关机时不要插入U盘，Android系统会破坏U盘文件的权限。</p><p>Armbian镜像我使用的是<a href=https://github.com/ophub/amlogic-s9xxx-armbian/releases/download/Armbian_jammy_lts_2023.05/Armbian_23.05.0_amlogic_s905d_jammy_6.1.27_server_2023.05.13.img.gz>Armbian_23.05.0_amlogic_s905d_jammy_6.1.27_server_2023.05.13.img.gz</a>，其中，<code>S905d</code>是N1所用的芯片，<code>Jammy</code>是Ubuntu的版本号，<code>6.1.27</code>代表使用的是最新版本的Linux内核。如果安装PiKVM，Debian系列（bullseye）的软件包有些太老了。</p><h2 id=修改dtb文件>修改dtb文件</h2><blockquote><p>好，到这里时，我会假设：N1已经刷成了Ubuntu风味的Armbian系统；连接好网络，有线无线都可以；能够输入命令——不管是直接插键盘显示器，或是通过SSH，还是直接从电路板上引出导线。</p></blockquote><p>在上述的Armbian引导文件中，默认的USB模式是Host，为了模拟鼠标、键盘等设备，需要将<code>dr_mode</code>从<code>host</code>更改为<code>peripheral</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。那么，我们需要重新编译dtb文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#09f;font-style:italic># 将dtb编译为dts文件</span>
</span></span><span style=display:flex><span>dtc -I dtb -O dts -o test.dts /boot/dtb/amlogic/meson-gxl-s905d-phicomm-n1.dtb
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic># 用你喜欢的编辑器打开这个文件</span>
</span></span><span style=display:flex><span>vim test.dts
</span></span></code></pre></div><p>在<code>test.dts</code>中搜索<code>dr_mode</code>，寻找首个<code>dr_mode = "host";</code>，改为<code>dr_mode = "peripheral";</code>。
这里的上下文大概是这样：
<img src=carbon.png alt=注意红字位置>
后面的<code>dr_mode</code>不必修改。不要问我为什么，这部分超出了我的能力。之后重新把dts编译回去，移动到<code>/boot/dtb/amlogic/</code>，并且修改启动项：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dtc -I dts -O dtb -o n1-test.dtb test.dts
</span></span><span style=display:flex><span>sudo mv n1-test.dtb /boot/dtb/amlogic/
</span></span><span style=display:flex><span>sudo vim /boot/uEnv.txt
</span></span></code></pre></div><p>把<code>FDT</code>一行改为<code>FDT=/dtb/amlogic/n1-test.dtb</code>：
<img src=carbon2.png alt=最近觉得carbon.now.sh还挺棒哒></p><p>然后重启系统。</p><h2 id=安装脚本>安装脚本</h2><blockquote><p>此时，假设你能够透明地访问github和其他网站，<code>curl google.com</code>返回<code>302</code>或者<code>200</code>。如果不行的话，可以尝试在N1上安装<a href=https://github.com/zfl9/ss-tproxy>zfl9/ss-tproxy</a>，让N1同时承担旁路网关的功能。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/toss-a/pikvm-armbian.git
</span></span><span style=display:flex><span><span style=color:#366>cd</span> pikvm-armbian
</span></span><span style=display:flex><span>./install.sh
</span></span></code></pre></div><p>在提示<code>"Do you want to apply custom patches? [y/n] "</code>时，选择N。</p><p>接下来，重启系统，再次运行<code>install.sh</code>，然后关机。</p><h2 id=连线和启动>连线和启动</h2><p>N1靠近HDMI接口的USB口已经改为OTG从机模式，把双公头USB线插在这里，另一头插到被控计算机上。这时候，如果视频采集卡插不上的话，拿出提前准备好的延长线。下面的照片来自<a href=https://pockies.github.io/2019/03/07/phicomm-n1/>这里</a>，照相技术牛逼疯了。</p><p><img src=n1.excalidraw.png alt=牛逼疯了！></p><p>重新插入电源，用随便的浏览器访问N1的IP地址，并忽略证书错误提示。初始用户名和密码都是<code>admin</code>，别忘了修改登录密码，用<code>sudo kvmd-htpasswd set admin</code>。</p><p>另外，感谢<a href=https://github.com/pikvm/pikvm>pikvm</a>项目，有钱的话就去支持<a href=https://pikvm.org/>他们的硬件</a>吧！</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Ref：<a href=https://github.com/toss-a/pikvm-armbian/blob/master/README-zh-CN.MD#%E7%AC%AC%E4%BA%8C%E6%AD%A5>README</a>，这个写的其实挺清楚的，比我的好。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></section></article></main><div class="w-full h-0 flex-none order-3"></div><aside role=contentinfo class="w-full md:w-2/5 xl:w-1/2 md:pr-12 lg:pr-20 xl:pr-24 order-4 md:order-3 md:sticky md:bottom-0 self-end max-w-2xl"><div class="md:float-right md:text-right leading-loose tracking-tight md:mb-2"><div class="md:max-w-xs flex flex-col md:items-end"><ul class="font-serif flex-grow-0 flex justify-between flex-wrap md:flex-col"><li class="px-1 md:px-0"><a href=/post/ title="归档 page">归档</a></li><li class="px-1 md:px-0"><a href=/categories/ title="分类 page">分类</a></li><li class="px-1 md:px-0"><a href=/tags/ title="标签 page">标签</a></li><li class="px-1 md:px-0"><a href=/about/ title="关于 page">关于</a></li><li class="px-1 md:px-0"><a href=/wallet/ title="云乞讨 page">云乞讨</a></li><li class="px-1 md:px-0"><a href=/sentences/ title="内心戏 page">内心戏</a></li><li class="px-1 md:px-0"><a href=https://heysh.xyz/ title="芽 page">芽</a></li><div id=fastSearch class=m-0><input id=searchInput type=text size=10 class="bg-gray-100 focus:outline-none border-b border-gray-100 focus:border-eucalyptus-300 md:text-right
placeholder-java-500 min-w-0 max-w-xxxs" placeholder=search><ul id=searchResults class="bg-gray-200 px-2 divide-y divide-gray-400"></ul></div></ul><div class="flex flex-wrap-reverse md:justify-end content-end md:content-start justify-start items-start max-h-16"><a href=https://github.com/heyeshuang target=_blank class="github icon pl-1 text-eucalyptus-400 hover:text-java-400" title="github link" rel=noopener aria-label="follow on github——Opens in a new window"><div class="fill-current h-8 w-8"><svg viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M5.883 18.653c-.3-.2-.558-.455-.86-.816a50.32 50.32.0 01-.466-.579c-.463-.575-.755-.84-1.057-.949a1 1 0 01.676-1.883c.752.27 1.261.735 1.947 1.588-.094-.117.34.427.433.539.19.227.33.365.44.438.204.137.587.196 1.15.14.023-.382.094-.753.202-1.095C5.38 15.31 3.7 13.396 3.7 9.64c0-1.24.37-2.356 1.058-3.292-.218-.894-.185-1.975.302-3.192a1 1 0 01.63-.582c.081-.024.127-.035.208-.047.803-.123 1.937.17 3.415 1.096A11.731 11.731.0 0112 3.315c.912.0 1.818.104 2.684.308 1.477-.933 2.613-1.226 3.422-1.096.085.013.157.03.218.05a1 1 0 01.616.58c.487 1.216.52 2.297.302 3.19.691.936 1.058 2.045 1.058 3.293.0 3.757-1.674 5.665-4.642 6.392.125.415.19.879.19 1.38a300.492 300.492.0 01-.012 2.716 1 1 0 01-.019 1.958c-1.139.228-1.983-.532-1.983-1.525l.002-.446.005-.705c.005-.708.007-1.338.007-1.998.0-.697-.183-1.152-.425-1.36-.661-.57-.326-1.655.54-1.752 2.967-.333 4.337-1.482 4.337-4.66.0-.955-.312-1.744-.913-2.404a1 1 0 01-.19-1.045c.166-.414.237-.957.096-1.614l-.01.003c-.491.139-1.11.44-1.858.949a1 1 0 01-.833.135A9.626 9.626.0 0012 5.315c-.89.0-1.772.119-2.592.35a1 1 0 01-.83-.134c-.752-.507-1.374-.807-1.868-.947-.144.653-.073 1.194.092 1.607a1 1 0 01-.189 1.045C6.016 7.89 5.7 8.694 5.7 9.64c0 3.172 1.371 4.328 4.322 4.66.865.097 1.201 1.177.544 1.748-.192.168-.429.732-.429 1.364v3.15c0 .986-.835 1.725-1.96 1.528a1 1 0 01-.04-1.962v-.99c-.91.061-1.662-.088-2.254-.485z"/></g></svg></div></a><a href=https://twitter.com/heyeshuang target=_blank class="twitter icon pl-1 text-eucalyptus-400 hover:text-java-400" title="twitter link" rel=noopener aria-label="follow on twitter——Opens in a new window"><div class="fill-current h-8 w-8"><svg viewBox="0 0 24 24"><g><path fill="none" d="M0 0h24v24H0z"/><path fill-rule="nonzero" d="M15.3 5.55a2.9 2.9.0 00-2.9 2.847l-.028 1.575a.6.6.0 01-.68.583l-1.561-.212c-2.054-.28-4.022-1.226-5.91-2.799-.598 3.31.57 5.603 3.383 7.372l1.747 1.098a.6.6.0 01.034.993L7.793 18.17c.947.059 1.846.017 2.592-.131 4.718-.942 7.855-4.492 7.855-10.348.0-.478-1.012-2.141-2.94-2.141zm-4.9 2.81a4.9 4.9.0 018.385-3.355c.711-.005 1.316.175 2.669-.645-.335 1.64-.5 2.352-1.214 3.331.0 7.642-4.697 11.358-9.463 12.309-3.268.652-8.02-.419-9.382-1.841.694-.054 3.514-.357 5.144-1.55C5.16 15.7-.329 12.47 3.278 3.786c1.693 1.977 3.41 3.323 5.15 4.037 1.158.475 1.442.465 1.973.538z"/></g></svg></div></a></div><div class="text-sm text-gray-500 leading-tight a-gray">&copy;贺叶霜，<a href=https://creativecommons.org/licenses/by-sa/4.0/deed.zh>CC BY-SA</a><br>Built with Hugo and theme <a href=https://github.com/heyeshuang/hugo-theme-tokiwa>Tokiwa</a>. 1804 words in this page.</div></div></div></aside><footer class="w-full md:w-3/5 xl:w-1/2 order-3 max-w-3xl md:order-4 pt-2"><hr class=double-line><div class="flex flex-wrap justify-between pb-2 leading-loose font-serif"><a class=flex-grow-0 href=/2023/05/10/through-nat/><svg class="fill-current inline-block h-4 w-4" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M7.828 11H20v2H7.828l5.364 5.364-1.414 1.414L4 12l7.778-7.778 1.414 1.414z"/></svg>
内网访问第三季：在运营商的CGNAT网络下
</a><a class=flex-grow-0 href=/2023/08/10/energy-cost/>一些矿渣的耗电量<svg class="fill-current inline-block h-4 w-4" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.172 11l-5.364-5.364 1.414-1.414L20 12l-7.778 7.778-1.414-1.414L16.172 13H4v-2z"/></svg></a></div><div><div class="font-serif pb-2 flex align-start leading-loose"><span class="heading pr-6 leading-loose">Related</span>
<span><a href=/2023/05/10/through-nat/>内网访问第三季：在运营商的CGNAT网络下</a>&nbsp;&nbsp;/&nbsp;
<a href=/2023/02/07/beyond-nat-2023/>仅IPv6家庭内网服务实现v6+v4双栈访问</a>&nbsp;&nbsp;/&nbsp;
<a href=/2022/05/22/connect-every-something/>几物互联</a>&nbsp;&nbsp;/&nbsp;
<a href=/2021/07/20/beyond-nat/>你可能并不需要内网穿透</a></span></div></div><hr><div class=pb-2><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//heysh.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><hr></footer><script src=/dist/app.js></script><script src=/lib/fuse.min.js></script><script src=/lib/fastsearch.js></script></div></body></html>